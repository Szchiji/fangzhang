{% extends "layout.html" %}
{% block content %}
<div class="card-custom">
    <div class="d-flex align-items-center mb-4">
        <div class="bg-primary bg-opacity-10 p-2 rounded-3 me-3"><i class="bi bi-chat-square-dots text-primary fs-4"></i></div>
        <h5 class="fw-bold m-0">æŸ¥è¯¢æŒ‡ä»¤ä¸æ¨¡æ¿é…ç½®</h5>
    </div>

    <div class="mb-4">
        <label class="small fw-bold text-secondary mb-2">è§¦å‘æŒ‡ä»¤</label>
        <input type="text" class="form-control border-0 bg-light py-2 px-3 rounded-3" 
               value="{{g[7] or 'æŸ¥è¯¢'}}" id="q_cmd" onchange="fastSave('cmd_query', this.value)">
    </div>

    <div class="mb-4">
        <label class="small fw-bold text-secondary mb-3 d-block">å›å¤æ¨¡æ¿ (å¯Œæ–‡æœ¬æ¨¡å¼)</label>
        <div class="d-flex flex-wrap gap-2 mb-3">
            <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="addTag('{onlineEmoji}')">âœ¨ åœ¨çº¿è¡¨æƒ…</button>
            <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="addTag('{è®¤è¯ç”¨æˆ·åå­—}')">ğŸ‘¤ ç”¨æˆ·åå­—</button>
            <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="addTag('{UID}')">ğŸ†” UID</button>
            <button class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="addTag('{åœ°åŒºValue}')">ğŸ“ åœ°åŒº</button>
            <button class="btn btn-outline-warning btn-sm rounded-pill px-3" onclick="addTag('{è€å¸ˆå}')">ğŸ´ è€å¸ˆå</button>
        </div>

        <div id="q-editor" style="height: 250px; border-radius: 0 0 15px 15px;">{{g[8]|safe}}</div>
    </div>

    <div class="p-4 rounded-4" style="background: #f8fafd; border: 2px dashed #cbd5e1;">
        <div class="small text-secondary mb-2"><i class="bi bi-eye me-1"></i> Telegram é¢„è§ˆæ•ˆæœï¼š</div>
        <div id="q-preview" class="small lh-base"></div>
    </div>

    <div class="text-end mt-4">
        <button class="btn btn-primary px-5 py-2 rounded-pill fw-bold shadow-sm" onclick="saveTpl()">ç¡®è®¤å‘å¸ƒ</button>
    </div>
</div>

<script>
let quill;
document.addEventListener('DOMContentLoaded', () => {
    quill = new Quill('#q-editor', {
        theme: 'snow',
        modules: { toolbar: [['bold', 'italic', 'underline'], ['link', {'color':[]}], ['clean']] }
    });
    quill.on('text-change', renderPreview);
    renderPreview();
});

function addTag(tag) {
    const range = quill.getSelection(true);
    quill.insertText(range.index, tag, {'bold': true, 'color': '#0d6efd'});
    quill.setSelection(range.index + tag.length);
}

function renderPreview() {
    let html = quill.root.innerHTML;
    const mock = (n, a) => html.replace(/{onlineEmoji}/g,'âœ…').replace(/{è®¤è¯ç”¨æˆ·åå­—}/g,n).replace(/{UID}/g,'888').replace(/{åœ°åŒºValue}/g,a).replace(/{è€å¸ˆå}/g,'ç‹è€å¸ˆ');
    document.getElementById('q-preview').innerHTML = `<div class="mb-1">${mock('å¼ ä¸‰','æ›¼è°·')}</div><div>${mock('æå››','å°åŒ—')}</div>`;
}

async function saveTpl() {
    const fd = new FormData();
    fd.append('sid','{{sid}}'); fd.append('gid','{{gid}}');
    fd.append('field','tpl_query'); fd.append('value', quill.root.innerHTML);
    await fetch('/api/save_group', {method:'POST', body:fd});
    alert("ä¿å­˜æˆåŠŸï¼");
}

async function fastSave(f, v) {
    const fd = new FormData();
    fd.append('sid','{{sid}}'); fd.append('gid','{{gid}}');
    fd.append('field', f); fd.append('value', v);
    await fetch('/api/save_group', {method:'POST', body:fd});
}
</script>
{% endblock %}
