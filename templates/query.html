{% extends "layout.html" %}
{% block content %}
<link href="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.snow.css" rel="stylesheet">

<div class="card p-4 border-0 shadow-sm" style="border-radius: 20px;">
    <div class="d-flex align-items-center mb-4">
        <div class="bg-primary bg-opacity-10 p-2 rounded-3 me-3">
            <i class="bi bi-chat-left-dots text-primary fs-4"></i>
        </div>
        <h5 class="fw-bold m-0">æŸ¥è¯¢æŒ‡ä»¤ä¸æ¨¡æ¿å¯Œæ–‡æœ¬é…ç½®</h5>
    </div>

    <div class="mb-4">
        <label class="small fw-bold text-secondary mb-2">æŸ¥è¯¢è§¦å‘æŒ‡ä»¤</label>
        <input type="text" class="form-control border-0 bg-light py-2" value="{{g[9] or 'æŸ¥è¯¢'}}" 
               style="border-radius: 10px;" onchange="updateField('query_cmd', this.value)">
    </div>

    <div class="mb-4">
        <label class="small fw-bold text-secondary mb-3 d-block">åœ¨çº¿äººå‘˜åˆ—è¡¨æ¨¡æ¿ (å¯Œæ–‡æœ¬æ¨¡å¼)</label>
        
        <div class="d-flex flex-wrap gap-2 mb-3">
            <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="insertPlaceholder('{onlineEmoji}')">âœ¨ åœ¨çº¿è¡¨æƒ…</button>
            <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="insertPlaceholder('{è®¤è¯ç”¨æˆ·åå­—}')">ğŸ‘¤ ç”¨æˆ·åå­—</button>
            <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="insertPlaceholder('{UID}')">ğŸ†” UID</button>
            <button class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="insertPlaceholder('{åœ°åŒºValue}')">ğŸ“ åœ°åŒº</button>
            <button class="btn btn-outline-warning btn-sm rounded-pill px-3" onclick="insertPlaceholder('{è€å¸ˆå}')">ğŸ´ è€å¸ˆå</button>
        </div>

        <div id="query-editor" style="height: 200px; background: white; border-radius: 0 0 12px 12px;">
            {{g[10]|safe}}
        </div>
    </div>

    <div class="p-4 rounded-4" style="background-color: #f8fafd; border: 2px dashed #e0e6ed;">
        <div class="small text-secondary mb-3 d-flex align-items-center"><i class="bi bi-eye-fill me-2"></i> å®æ—¶é¢„è§ˆï¼š</div>
        <div id="query_preview" class="small lh-lg"></div>
    </div>

    <div class="text-end mt-4">
        <button class="btn btn-primary px-5 py-2 rounded-pill fw-bold shadow" onclick="saveTemplate()">ç¡®è®¤å‘å¸ƒå¹¶ä¿å­˜</button>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.min.js"></script>
<script>
let queryQuill;

// åˆå§‹åŒ–ç¼–è¾‘å™¨
document.addEventListener('DOMContentLoaded', function() {
    queryQuill = new Quill('#query-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                ['link', { 'color': [] }, { 'background': [] }],
                ['clean']
            ]
        },
        placeholder: 'åœ¨æ­¤é…ç½®æŸ¥è¯¢å›å¤æ¨¡æ¿...'
    });

    // ç›‘å¬å†…å®¹å˜åŒ–åŒæ­¥é¢„è§ˆ
    queryQuill.on('text-change', syncQueryPreview);
    syncQueryPreview();
});

// å…³é”®åŠŸèƒ½ï¼šå‘å¯Œæ–‡æœ¬å…‰æ ‡å¤„æ’å…¥å ä½ç¬¦
function insertPlaceholder(tag) {
    const range = queryQuill.getSelection(true);
    // åœ¨å…‰æ ‡å¤„æ’å…¥æ–‡å­—
    queryQuill.insertText(range.index, tag, {
        'color': '#0d6efd', // ç»™æ’å…¥çš„æ ‡ç­¾ä¸€ä¸ªé«˜äº®è‰²ï¼Œæ–¹ä¾¿è¯†åˆ«
        'bold': true
    });
    // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥å†…å®¹ä¹‹å
    queryQuill.setSelection(range.index + tag.length);
}

function syncQueryPreview() {
    const html = queryQuill.root.innerHTML;
    const box = document.getElementById('query_preview');
    
    const mock = (name, area) => html
        .replace(/{onlineEmoji}/g, 'âœ…')
        .replace(/{è®¤è¯ç”¨æˆ·åå­—}/g, name)
        .replace(/{UID}/g, '888888')
        .replace(/{åœ°åŒºValue}/g, ' - ' + area)
        .replace(/{è€å¸ˆå}/g, 'ç‹è€å¸ˆ');

    box.innerHTML = `<div class="mb-1">${mock('å¼ ä¸‰', 'å°åŒ—')}</div><div>${mock('æå››', 'æ›¼è°·')}</div>`;
}

async function saveTemplate() {
    const content = queryQuill.root.innerHTML;
    await updateField('query_tpl', content);
    alert("æ¨¡æ¿å·²æ›´æ–°");
}

async function updateField(f, v) {
    const fd = new FormData();
    fd.append('sid', '{{sid}}'); fd.append('gid', '{{gid}}');
    fd.append('field', f); fd.append('value', v);
    await fetch('/api/save', {method: 'POST', body: fd});
}
</script>

<style>
    .ql-toolbar.ql-snow { border: 1px solid #f0f2f5 !important; background: #f8fafd; border-radius: 12px 12px 0 0; }
    .ql-container.ql-snow { border: 1px solid #f0f2f5 !important; border-top: none !important; border-radius: 0 0 12px 12px; }
</style>
{% endblock %}
