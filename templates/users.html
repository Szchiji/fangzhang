{% extends "layout.html" %}
{% block content %}
<div class="card p-4 border-0 shadow-sm">
    <div class="d-flex justify-content-between mb-4">
        <h5 class="fw-bold m-0">认证用户管理</h5>
        <button class="btn btn-dark rounded-pill px-4" onclick="openUModal()">+ 新增授权</button>
    </div>
    
    <table class="table align-middle">
        <thead><tr class="small text-muted"><th>姓名/UID</th><th>到期时间</th><th>操作</th></tr></thead>
        <tbody>
            {% for u in users %}
            <tr>
                <td><b>{{u[2]}}</b><br><small class="text-muted">{{u[0]}}</small></td>
                <td>{{u[7] or '永久'}}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary rounded-pill px-3" 
                            onclick="handleEdit('{{u[0]}}','{{u[2]}}','{{u[4]}}','{{u[5]}}','{{u[7]}}')">
                        修改信息
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="userForm" class="modal-content border-0 shadow">
            <div class="modal-body p-4">
                <h6 class="fw-bold mb-4" id="modalTitle">用户授权设置</h6>
                <div class="mb-3"><label class="small fw-bold">用户 ID</label><input type="text" name="user_id" id="uid_val" class="form-control bg-light"></div>
                <div class="mb-3"><label class="small fw-bold">姓名</label><input type="text" name="name" id="uname_val" class="form-control bg-light"></div>
                <div class="row mb-3">
                    <div class="col-6"><label class="small fw-bold">地区</label><input type="text" name="area" id="uarea_val" class="form-control bg-light"></div>
                    <div class="col-6"><label class="small fw-bold">老师</label><input type="text" name="teacher" id="uteacher_val" class="form-control bg-light"></div>
                </div>
                <div class="mb-4"><label class="small fw-bold">有效期</label><input type="date" name="expire_at" id="uexpire_val" class="form-control bg-light"></div>
                <button type="button" class="btn btn-primary w-100 py-3 rounded-pill fw-bold" onclick="saveUserData()">立即保存</button>
            </div>
        </form>
    </div>
</div>

<script>
const uModalObj = new bootstrap.Modal(document.getElementById('userModal'));

function openUModal() {
    document.getElementById('userForm').reset();
    document.getElementById('uid_val').readOnly = false;
    document.getElementById('modalTitle').innerText = "新增授权成员";
    uModalObj.show();
}

function handleEdit(id, name, area, teacher, expire) {
    document.getElementById('uid_val').value = id;
    document.getElementById('uid_val').readOnly = true;
    document.getElementById('uname_val').value = name;
    document.getElementById('uarea_val').value = area;
    document.getElementById('uteacher_val').value = teacher;
    document.getElementById('uexpire_val').value = (expire && expire !== 'None') ? expire : '';
    document.getElementById('modalTitle').innerText = "修改认证信息";
    uModalObj.show();
}

async function saveUserData() {
    const fd = new FormData(document.getElementById('userForm'));
    fd.append('sid', '{{sid}}'); fd.append('gid', '{{gid}}');
    
    try {
        const res = await fetch('/api/add_user', { method: 'POST', body: fd });
        if(res.ok) {
            location.reload();
        } else {
            alert("保存失败，请检查网络");
        }
    } catch (e) {
        alert("请求错误");
    }
}
</script>
{% endblock %}
