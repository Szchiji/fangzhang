<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœºå™¨äººç®¡ç†åå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: #2c3e50; color: white; position: fixed; height: 100%; padding-top: 20px; }
        .sidebar a { color: #bdc3c7; text-decoration: none; padding: 12px 20px; display: block; }
        .sidebar a:hover, .sidebar a.active { background: #34495e; color: white; }
        .main-content { margin-left: 250px; flex: 1; padding: 30px; }
        .card { border: none; border-radius: 12px; }
        .editor-container { background: white; border-radius: 0 0 8px 8px; }
        .ql-toolbar { background: #eee; border-radius: 8px 8px 0 0; }
        .btn-var { margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="px-4 mb-4">
        <h4 class="fw-bold"><i class="bi bi-robot"></i> Bot Admin</h4>
        <small class="text-secondary">ç¾¤ç»„ ID: {{ gid }}</small>
    </div>
    <a href="#section-base" class="active"><i class="bi bi-gear-fill me-2"></i> åŸºç¡€è®¾ç½®</a>
    <a href="#section-users"><i class="bi bi-person-badge-fill me-2"></i> è®¤è¯è€å¸ˆç®¡ç†</a>
    <a href="#section-timers"><i class="bi bi-alarm-fill me-2"></i> å®šæ—¶ä»»åŠ¡</a>
</div>

<div class="main-content">
    
    <section id="section-base" class="mb-5">
        <h3 class="fw-bold mb-4">âš™ï¸ åŸºç¡€æ ·å¼é…ç½®</h3>
        <form action="/api/save" method="post" id="form-base">
            <input type="hidden" name="sid" value="{{ sid }}">
            <input type="hidden" name="gid" value="{{ gid }}">
            
            <div class="card p-4 shadow-sm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">è‡ªå®šä¹‰å­—æ®µ (è‹±æ–‡é€—å·éš”å¼€)</label>
                        <input type="text" name="fields" class="form-control" value="{{ group.custom_fields }}" placeholder="å¦‚ï¼šåœ°åŒº,ä»·æ ¼,å¾®ä¿¡å·">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">æ‰“å¡ç‚¹èµå›¾æ ‡</label>
                        <input type="text" name="emoji" class="form-control" value="{{ group.like_emoji }}">
                    </div>
                </div>

                <div class="mb-3 mt-3 p-3 bg-light rounded border">
                    <label class="form-label d-block small fw-bold text-primary">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¿«é€Ÿæ’å…¥å˜é‡ï¼š</label>
                    <div class="d-flex flex-wrap gap-2" id="var-buttons">
                        <button type="button" class="btn btn-sm btn-dark btn-var" onclick="insertVar('{å§“åValue}')">{å§“å}</button>
                        <button type="button" class="btn btn-sm btn-info text-white btn-var" onclick="insertVar('{onlineEmoji}')">{çŠ¶æ€å›¾æ ‡}</button>
                        {% if group.custom_fields %}
                            {% for f in group.custom_fields.split(',') %}
                            <button type="button" class="btn btn-sm btn-outline-primary btn-var" onclick="insertVar('{{'{'}}{{f}}Value{{'}'}}')">{{f}}</button>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">åœ¨çº¿åå•æ¨¡æ¿</label>
                        <div id="editor-list" class="editor-container" style="height: 150px;">{{ group.list_template|safe }}</div>
                        <input type="hidden" name="list_t" id="input-list">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">æ‰“å¡æˆåŠŸå›å¤</label>
                        <div id="editor-check" class="editor-container" style="height: 150px;">{{ group.checkin_template|safe }}</div>
                        <input type="hidden" name="check_t" id="input-check">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3 w-100 py-2" onclick="syncEditors()">ä¿å­˜é…ç½®</button>
            </div>
        </form>
    </section>

    <section id="section-users" class="mb-5">
        <h3 class="fw-bold mb-4">ğŸ‘¤ è®¤è¯è€å¸ˆåº“</h3>
        <div class="card p-4 shadow-sm mb-4">
            <form action="/api/user" method="post">
                <input type="hidden" name="sid" value="{{ sid }}">
                <input type="hidden" name="gid" value="{{ gid }}">
                <input type="hidden" name="action" value="add">
                <div class="row g-2">
                    <div class="col-md-2"><input type="text" name="user_id" class="form-control" placeholder="UID" required></div>
                    <div class="col-md-2"><input type="text" name="name" class="form-control" placeholder="å§“å" required></div>
                    <div class="col-md-6"><input type="text" name="data" class="form-control" placeholder='JSONæ•°æ®ï¼š{"åœ°åŒº":"å—å±±", "ä»·æ ¼":"1000"}' required></div>
                    <div class="col-md-2"><button type="submit" class="btn btn-success w-100">æ·»åŠ /æ›´æ–°</button></div>
                </div>
            </form>
        </div>
        <div class="card shadow-sm overflow-hidden">
            <table class="table table-hover mb-0">
                <thead class="table-light"><tr><th>UID</th><th>å§“å</th><th>è¯¦æƒ…æ•°æ®</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td><code>{{ u.user_id }}</code></td>
                        <td>{{ u.name }}</td>
                        <td class="small">{{ u.data_json }}</td>
                        <td>
                            <form action="/api/user" method="post" style="display:inline">
                                <input type="hidden" name="sid" value="{{ sid }}"><input type="hidden" name="gid" value="{{ gid }}">
                                <input type="hidden" name="user_id" value="{{ u.user_id }}"><input type="hidden" name="action" value="del">
                                <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <section id="section-timers" class="mb-5">
        <h3 class="fw-bold mb-4">â° å®šæ—¶å¤šåª’ä½“å‘é€</h3>
        <div class="card p-4 shadow-sm mb-4">
            <form action="/api/timer" method="post" id="form-timer">
                <input type="hidden" name="sid" value="{{ sid }}"><input type="hidden" name="gid" value="{{ gid }}">
                <input type="hidden" name="action" value="add">
                <div class="row">
                    <div class="col-md-3 mb-2"><input type="text" name="remark" class="form-control" placeholder="å¤‡æ³¨åç§°" required></div>
                    <div class="col-md-3 mb-2"><select name="m_type" class="form-select"><option>çº¯æ–‡æœ¬</option><option>å›¾ç‰‡</option><option>è§†é¢‘</option></select></div>
                    <div class="col-md-6 mb-2"><input type="text" name="m_url" class="form-control" placeholder="åª’ä½“é“¾æ¥ (å›¾ç‰‡/è§†é¢‘ URL)"></div>
                    <div class="col-md-12 mb-2">
                        <div id="editor-timer" style="height: 100px;">è¾“å…¥æ¶ˆæ¯æ­£æ–‡...</div>
                        <input type="hidden" name="content" id="input-timer">
                    </div>
                    <div class="col-md-3 mb-2"><label class="small">é¢‘ç‡(å°æ—¶)</label><input type="number" name="hours" class="form-control" value="1"></div>
                    <div class="col-md-3 mb-2"><label class="small">å¼€å§‹æ—¶é—´</label><input type="datetime-local" name="start" class="form-control"></div>
                    <div class="col-md-3 mb-2"><label class="small">ç»“æŸæ—¶é—´</label><input type="datetime-local" name="end" class="form-control"></div>
                    <div class="col-md-3 mb-2"><label class="small">è‡ªåŠ¨ç½®é¡¶</label><select name="is_pin" class="form-select"><option value="0">å¦</option><option value="1">æ˜¯</option></select></div>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-2" onclick="syncTimerEditor()">æ·»åŠ å®šæ—¶ä»»åŠ¡</button>
            </form>
        </div>
    </section>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    // åˆå§‹åŒ–ç¼–è¾‘å™¨
    var quillOptions = { theme: 'snow', modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'color': [] }], ['clean']] } };
    var quillList = new Quill('#editor-list', quillOptions);
    var quillCheck = new Quill('#editor-check', quillOptions);
    var quillTimer = new Quill('#editor-timer', quillOptions);

    var currentFocusEditor = quillList;
    quillList.on('selection-change', range => { if(range) currentFocusEditor = quillList; });
    quillCheck.on('selection-change', range => { if(range) currentFocusEditor = quillCheck; });

    // æ’å…¥å ä½ç¬¦é€»è¾‘
    function insertVar(val) {
        const range = currentFocusEditor.getSelection(true);
        currentFocusEditor.insertText(range.index, val + ' ');
        currentFocusEditor.setSelection(range.index + val.length + 1);
    }

    function syncEditors() {
        document.getElementById('input-list').value = quillList.root.innerHTML;
        document.getElementById('input-check').value = quillCheck.root.innerHTML;
    }

    function syncTimerEditor() {
        document.getElementById('input-timer').value = quillTimer.root.innerHTML;
    }
</script>
</body>
</html>
