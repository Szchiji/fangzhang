<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†åå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar { width: 250px; height: 100vh; position: fixed; background: #212529; color: white; padding: 20px; }
        .content { margin-left: 250px; padding: 30px; }
        .nav-link { color: #adb5bd; cursor: pointer; border-radius: 5px; margin-bottom: 5px; }
        .nav-link.active { background: #0d6efd; color: white; }
        .expired { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="sidebar d-flex flex-column">
        <h4>æœºå™¨äººæ§åˆ¶å°</h4><hr>
        <div class="nav flex-column mb-auto">
            <a class="nav-link active" onclick="location.reload()">ğŸ‘¤ è®¤è¯ç®¡ç†</a>
            <a class="nav-link" href="/portal?sid={{sid}}">ğŸ”™ åˆ‡æ¢ç¾¤ç»„</a>
        </div>
    </div>

    <div class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{ group.group_name }}</h2>
            <button class="btn btn-primary" onclick="openAddModal()">+ æ–°å¢è®¤è¯(å¸¦å¤©æ•°)</button>
        </div>

        <form class="input-group mb-4" method="get" action="/manage">
            <input type="hidden" name="sid" value="{{sid}}"><input type="hidden" name="gid" value="{{gid}}">
            <input type="text" name="q" class="form-control" placeholder="æœç´¢ IDã€åå­—æˆ–åœ°åŒº..." value="{{q}}">
            <button class="btn btn-outline-secondary" type="submit">æœç´¢</button>
        </form>

        <div class="card shadow-sm">
            <table class="table align-middle mb-0">
                <thead class="table-light">
                    <tr><th>æ’åº</th><th>UID/åå­—</th><th>èµ„æ–™</th><th>æœ‰æ•ˆæœŸçŠ¶æ€</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td>{{ u.sort_order }}</td>
                        <td><code>{{ u.user_id }}</code><br><b>{{ u.name }}</b></td>
                        <td>{{ u.area }} | {{ u.price }} | {{ u.chest_size }}</td>
                        <td>
                            {% if u.expire_at == 0 %}
                                <span class="badge bg-success">æ°¸ä¹…æœ‰æ•ˆ</span>
                            {% elif u.expire_at < now %}
                                <span class="expired">âŒ å·²è¿‡æœŸç¦è¨€</span>
                            {% else %}
                                <span class="text-primary">å‰© {{ ((u.expire_at - now) // 86400) + 1 }} å¤©</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser('{{u.user_id}}','{{u.name}}','{{u.area}}','{{u.price}}','{{u.chest_size}}','{{u.sort_order}}')">ç¼–è¾‘</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content" action="/api/save_user" method="post">
                <input type="hidden" name="sid" value="{{sid}}"><input type="hidden" name="gid" value="{{gid}}">
                <div class="modal-header"><h5>ç”¨æˆ·ä¿¡æ¯è®¾ç½®</h5></div>
                <div class="modal-body row g-3">
                    <div class="col-12"><label>Telegram UID</label><input type="number" name="user_id" id="f_id" class="form-control" required></div>
                    <div class="col-md-6"><label>åå­—</label><input type="text" name="name" id="f_name" class="form-control" required></div>
                    <div class="col-md-6"><label>åœ°åŒº</label><input type="text" name="area" id="f_area" class="form-control"></div>
                    <div class="col-md-4"><label>ä»·æ ¼</label><input type="text" name="price" id="f_price" class="form-control"></div>
                    <div class="col-md-4"><label>èº«æ</label><input type="text" name="chest" id="f_chest" class="form-control"></div>
                    <div class="col-md-4"><label>æ’åº</label><input type="number" name="sort" id="f_sort" class="form-control" value="0"></div>
                    <div class="col-12">
                        <label class="text-primary fw-bold">è®¾ç½®æœ‰æ•ˆæœŸ (å¤©)</label>
                        <select name="days" class="form-select border-primary">
                            <option value="0">æ°¸ä¹…</option>
                            <option value="7">7 å¤© (å‘¨è´¹)</option>
                            <option value="30">30 å¤© (æœˆè´¹)</option>
                            <option value="90">90 å¤© (å­£è´¹)</option>
                        </select>
                        <small class="text-muted">è¿‡æœŸåæœºå™¨äººå°†è‡ªåŠ¨æ‰§è¡Œç¦è¨€ã€‚</small>
                    </div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary w-100">ä¿å­˜å¹¶åŒæ­¥æƒé™</button></div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const m = new bootstrap.Modal(document.getElementById('userModal'));
        function openAddModal() {
            document.getElementById('f_id').value=''; document.getElementById('f_id').readOnly=false;
            m.show();
        }
        function editUser(id, n, a, p, c, s) {
            document.getElementById('f_id').value=id; document.getElementById('f_id').readOnly=true;
            document.getElementById('f_name').value=n; document.getElementById('f_area').value=a;
            document.getElementById('f_price').value=p; document.getElementById('f_chest').value=c;
            document.getElementById('f_sort').value=s;
            m.show();
        }
    </script>
</body>
</html>
