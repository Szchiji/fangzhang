{% extends "layout.html" %}
{% block content %}
<link href="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.snow.css" rel="stylesheet">

<div class="card p-4 border-0 shadow-sm" style="border-radius: 16px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold m-0"><i class="bi bi-clock-history me-2 text-primary"></i>定时任务计划</h5>
        <button class="btn btn-primary rounded-pill px-4 shadow-sm" onclick="handleOpenModal()">+ 新增任务</button>
    </div>

    <div class="row g-3">
        {% for t in tasks %}
        <div class="col-md-6" id="t-card-{{t[0]}}">
            <div class="card bg-light p-3 border-0 h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="badge bg-white text-primary mb-2 shadow-sm">每 {{t[3]}} 分钟</span>
                        <h6 class="fw-bold text-dark mb-1">{{t[4]}}</h6>
                    </div>
                    <button class="btn btn-sm btn-outline-danger border-0 rounded-circle" 
                            onclick="handleDeleteTask('{{t[0]}}', '{{t[4]}}')">
                        <i class="bi bi-trash3"></i>
                    </button>
                </div>
                <div class="mt-2 small text-muted text-truncate" style="max-height: 40px;">
                    {{t[2]|safe}}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-body p-4">
                <div class="d-flex justify-content-between mb-4">
                    <h6 class="fw-bold m-0">配置富消息定时任务</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="mb-3">
                    <label class="small fw-bold text-secondary mb-2">任务名称 (备注)</label>
                    <input type="text" id="t_name" class="form-control bg-light border-0 py-2" placeholder="如：每日打卡提醒">
                </div>

                <div class="mb-3">
                    <label class="small fw-bold text-secondary mb-2">消息内容 (支持 B/I/U/链接)</label>
                    <div id="editor-wrapper" style="height: 250px; background: white; border-radius: 0 0 12px 12px;"></div>
                </div>

                <div class="mb-4">
                    <label class="small fw-bold text-secondary mb-2">发送频率 (分钟)</label>
                    <input type="number" id="t_time" class="form-control bg-light border-0 py-2" value="60">
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-light flex-grow-1 rounded-pill py-3" data-bs-dismiss="modal">取消</button>
                    <button class="btn btn-primary flex-grow-1 rounded-pill py-3 fw-bold shadow-sm" onclick="submitTask()">保存并发布任务</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.min.js"></script>
<script>
let quillInstance = null;
const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));

function handleOpenModal() {
    taskModal.show();
    setTimeout(() => {
        if (!quillInstance) {
            quillInstance = new Quill('#editor-wrapper', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        ['link', 'blockquote'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: '输入你想发送的消息内容...'
            });
        }
    }, 400);
}

// 保存
async function submitTask() {
    const name = document.getElementById('t_name').value;
    const content = quillInstance.root.innerHTML;
    const cron = document.getElementById('t_time').value;

    if(!name || quillInstance.getText().trim().length === 0) return alert("请填写任务名称和内容");

    const fd = new FormData();
    fd.append('sid', '{{sid}}'); fd.append('gid', '{{gid}}');
    fd.append('remark', name); fd.append('content', content); fd.append('cron', cron);

    const res = await fetch('/api/add_task', { method: 'POST', body: fd });
    if(res.ok) location.reload();
}

// 统一风格的删除函数
async function handleDeleteTask(tid, name) {
    if(!confirm(`确定要删除定时任务【${name}】吗？`)) return;
    
    const fd = new FormData();
    fd.append('sid', '{{sid}}');
    fd.append('tid', tid);
    
    try {
        const res = await fetch('/api/del_task', { method: 'POST', body: fd });
        if(res.ok) {
            // 动画效果移除卡片
            const card = document.getElementById(`t-card-${tid}`);
            card.style.transition = '0.3s';
            card.style.opacity = '0';
            setTimeout(() => card.remove(), 300);
        }
    } catch (e) {
        alert("删除失败，请检查网络");
    }
}
</script>

<style>
    /* 微调编辑器 UI */
    .ql-toolbar.ql-snow { border: 1px solid #f0f2f5 !important; background: #f8fafd; border-radius: 12px 12px 0 0; }
    .ql-container.ql-snow { border: 1px solid #f0f2f5 !important; border-top: none !important; border-radius: 0 0 12px 12px; }
</style>
{% endblock %}
