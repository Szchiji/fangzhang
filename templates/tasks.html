{% extends "layout.html" %}
{% block content %}
<link href="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.snow.css" rel="stylesheet">

<div class="card p-4 border-0 shadow-sm" style="border-radius: 20px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold m-0">ğŸš€ å‘å¸ƒå¯Œæ¶ˆæ¯ä»»åŠ¡</h5>
        <button class="btn btn-primary rounded-pill px-4" onclick="openTaskModal()">+ æ–°å¢å®šæ—¶</button>
    </div>

    <div class="row g-3">
        {% for t in tasks %}
        <div class="col-md-6" id="t-{{t[0]}}">
            <div class="card bg-light p-3 border-0">
                <div class="d-flex justify-content-between">
                    <b class="text-dark">{{t[4]}}</b>
                    <i class="bi bi-trash text-danger" style="cursor:pointer" onclick="delT('{{t[0]}}')"></i>
                </div>
                <div class="mt-2 small text-muted text-truncate">{{t[2]|safe}}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="tModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-body p-4">
                <h6 class="fw-bold mb-4">é…ç½®å¯Œæ¶ˆæ¯å†…å®¹</h6>
                
                <div class="mb-3">
                    <label class="small fw-bold mb-2">ä»»åŠ¡åç§°</label>
                    <input type="text" id="t_remark" class="form-control bg-light border-0" placeholder="ä»»åŠ¡å¤‡æ³¨">
                </div>

                <div class="mb-3">
                    <label class="small fw-bold mb-2">å†…å®¹ç¼–è¾‘ (å¯¹é½æˆªå›¾é£æ ¼)</label>
                    <div id="editor-container" style="height: 250px; background: #fff; border-radius: 0 0 12px 12px;"></div>
                </div>

                <div class="mb-4">
                    <label class="small fw-bold mb-2">å‘é€é¢‘ç‡ (åˆ†é’Ÿ)</label>
                    <input type="number" id="t_cron" class="form-control bg-light border-0" value="60">
                </div>

                <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow" onclick="saveTask()">ç¡®è®¤å‘å¸ƒä»»åŠ¡</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.min.js"></script>
<script>
let quill;
const modal = new bootstrap.Modal('#tModal');

function openTaskModal() {
    modal.show();
    // å¼¹çª—å¼€å¯åæ¸²æŸ“ç¼–è¾‘å™¨
    if(!quill) {
        quill = new Quill('#editor-container', {
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],        // åŠ ç²— æ–œä½“ ä¸‹åˆ’çº¿ åˆ é™¤çº¿
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],    // åˆ—è¡¨
                    ['link', 'clean']                                // é“¾æ¥ã€æ¸…é™¤æ ¼å¼
                ]
            },
            placeholder: 'è¾“å…¥æ¶ˆæ¯æè¿°ï¼Œæ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼...',
            theme: 'snow'
        });
    }
}

async function saveTask() {
    const fd = new FormData();
    fd.append('sid', '{{sid}}'); fd.append('gid', '{{gid}}');
    fd.append('remark', document.getElementById('t_remark').value);
    fd.append('cron', document.getElementById('t_cron').value);
    // å…³é”®ï¼šå¯¼å‡º HTML ç»™æœºå™¨äººå‘é€
    fd.append('content', quill.root.innerHTML);

    await fetch('/api/add_task', { method: 'POST', body: fd });
    location.reload();
}

async function delT(tid) {
    if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
    const fd = new FormData(); fd.append('sid','{{sid}}'); fd.append('tid',tid);
    await fetch('/api/del_task', { method: 'POST', body: fd });
    document.getElementById('t-'+tid).remove();
}
</script>

<style>
    /* å¼ºåˆ¶è°ƒæ•´ç¼–è¾‘å™¨ UIï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´åƒä½ æˆªå›¾é‡Œçš„æ ·å­ */
    .ql-toolbar.ql-snow {
        border: none !important;
        background: #f8fafd;
        border-radius: 12px 12px 0 0;
        padding: 10px;
    }
    .ql-container.ql-snow {
        border: 1px solid #f0f2f5 !important;
        border-top: none !important;
    }
    .ql-editor { font-size: 15px; color: #444; }
</style>
{% endblock %}
