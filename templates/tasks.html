{% extends "layout.html" %}
{% block content %}
<div class="card p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="fw-bold m-0"><i class="bi bi-alarm me-2 text-primary"></i>å®šæ—¶ä»»åŠ¡ç®¡ç†</h5>
            <small class="text-muted">è®¾ç½®ç¾¤ç»„è‡ªåŠ¨å¹¿æ’­æ¶ˆæ¯ï¼Œæ”¯æŒå®šæ—¶æ’¤å›ä»¥ä¿æŒç¾¤æ´å‡€</small>
        </div>
        <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#taskModal">
            <i class="bi bi-plus-lg me-1"></i> æ–°å»ºè®¡åˆ’
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="bg-light">
                <tr class="small text-muted">
                    <th>ä»»åŠ¡å¤‡æ³¨</th><th>å‘é€é¢‘ç‡</th><th>è‡ªåŠ¨æ’¤å›</th><th>çŠ¶æ€</th><th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for t in tasks %}
                <tr id="task-row-{{t[0]}}">
                    <td class="fw-bold">{{ t[8] or 'æœªå‘½åä»»åŠ¡' }}</td>
                    <td><span class="badge bg-info-soft text-info">{{ t[6] }}</span></td>
                    <td>{{ t[7] if t[7] != '0' else 'æ°¸ä¸æ’¤å›' }}</td>
                    <td><span class="badge bg-success-soft text-success">â— é˜Ÿåˆ—ä¸­</span></td>
                    <td>
                        <button class="btn btn-link text-danger p-0" onclick="deleteTask('{{t[0]}}')">åˆ é™¤</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1">
    <form id="taskForm" class="modal-dialog modal-lg border-0">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header">
                <h6 class="modal-title fw-bold">åˆ›å»ºå®šæ—¶å¹¿æ’­è®¡åˆ’</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="sid" value="{{sid}}">
                <input type="hidden" name="gid" value="{{gid}}">
                
                <div class="mb-3">
                    <label class="small fw-bold text-muted mb-2">ä»»åŠ¡å¤‡æ³¨</label>
                    <input type="text" name="remark" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥åˆé—´æ¨å¹¿" required>
                </div>

                <div class="mb-3">
                    <label class="small fw-bold text-muted mb-2">å¹¿æ’­å†…å®¹ (æ”¯æŒå¯Œæ–‡æœ¬é“¾æ¥)</label>
                    <div id="editor" style="height: 200px; background: #fff;"></div>
                    <input type="hidden" name="content_html" id="content_html">
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="small fw-bold text-muted mb-2">å‘é€é¢‘ç‡</label>
                        <select name="cron" class="form-select">
                            <option value="30">æ¯ 30 åˆ†é’Ÿ</option>
                            <option value="60">æ¯ 1 å°æ—¶</option>
                            <option value="180">æ¯ 3 å°æ—¶</option>
                            <option value="1440">æ¯å¤©ä¸€æ¬¡</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="small fw-bold text-muted mb-2">è‡ªåŠ¨æ’¤å› (ç§’)</label>
                        <input type="number" name="delete_after" class="form-control" placeholder="0 ä¸ºä¸æ’¤å›" value="300">
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" onclick="submitTask()" class="btn btn-primary w-100 rounded-pill py-2">
                    <i class="bi bi-rocket-takeoff me-2"></i>ç«‹å³åŠ å…¥æ‰§è¡Œåºåˆ—
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    // åˆå§‹åŒ–ç¼–è¾‘å™¨
    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'åœ¨æ­¤è¾“å…¥è¦æ¨é€çš„æ¶ˆæ¯å†…å®¹...',
        modules: { toolbar: [['bold', 'italic', 'link'], [{'color': []}]] }
    });

    // AJAX æäº¤ä»»åŠ¡
    async function submitTask() {
        const html = quill.root.innerHTML;
        document.getElementById('content_html').value = html;
        
        const fd = new FormData(document.getElementById('taskForm'));
        const res = await fetch('/api/add_task', { method: 'POST', body: fd });
        
        if (res.ok) {
            showToast("ğŸš€ å®šæ—¶è®¡åˆ’å·²å¯åŠ¨ï¼");
            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
            setTimeout(() => location.reload(), 1000); // åˆ·æ–°æŸ¥çœ‹æ–°ä»»åŠ¡
        }
    }

    async function deleteTask(tid) {
        if(!confirm('ç¡®å®šå–æ¶ˆæ­¤å®šæ—¶ä»»åŠ¡å—ï¼Ÿ')) return;
        const fd = new FormData();
        fd.append('tid', tid); fd.append('sid', '{{sid}}');
        const res = await fetch('/api/del_task', { method: 'POST', body: fd });
        if(res.ok) {
            showToast("ğŸ—‘ï¸ ä»»åŠ¡å·²ç§»é™¤");
            document.getElementById(`task-row-${tid}`).remove();
        }
    }
</script>
<style>
    .bg-info-soft { background: #e0f2fe; color: #0369a1; }
    .bg-success-soft { background: #dcfce7; color: #15803d; }
    .ql-toolbar.ql-snow { border-top-left-radius: 8px; border-top-right-radius: 8px; border-color: #e2e8f0; }
    .ql-container.ql-snow { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; border-color: #e2e8f0; }
</style>
{% endblock %}
