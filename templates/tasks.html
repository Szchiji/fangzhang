{% extends "layout.html" %}
{% block content %}
<div class="card-custom">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold m-0"><i class="bi bi-megaphone me-2 text-primary"></i>自动广播计划</h5>
        <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addTaskModal">+ 新增广播</button>
    </div>

    <div class="row g-3">
        {% for t in tasks %}
        <div class="col-md-6" id="task-{{t[0]}}">
            <div class="p-3 rounded-4 bg-light border-0 position-relative h-100">
                <span class="badge bg-primary mb-2">每 {{t[3]}} 分钟</span>
                <div class="fw-bold mb-1">{{t[4]}}</div>
                <div class="small text-muted text-truncate mb-3">{{t[2]|striptags}}</div>
                <button class="btn btn-sm btn-link text-danger p-0 position-absolute top-0 end-0 m-3" onclick="delTask('{{t[0]}}')">
                    <i class="bi bi-x-circle-fill fs-5"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px;">
            <div class="modal-body p-4">
                <h6 class="fw-bold mb-3">配置新广播</h6>
                <input type="text" id="tk_name" class="form-control mb-3 bg-light border-0" placeholder="任务备注">
                <div id="tk-editor" style="height: 150px;" class="mb-3"></div>
                <input type="number" id="tk_cron" class="form-control mb-4 bg-light border-0" placeholder="发送间隔(分钟)">
                <button class="btn btn-primary w-100 rounded-pill py-2 fw-bold" onclick="submitTask()">保存并开启</button>
            </div>
        </div>
    </div>
</div>

<script>
let tkQuill;
document.addEventListener('DOMContentLoaded', () => {
    tkQuill = new Quill('#tk-editor', { theme: 'snow' });
});

async function submitTask() {
    const fd = new FormData();
    fd.append('sid','{{sid}}'); fd.append('gid','{{gid}}');
    fd.append('remark', document.getElementById('tk_name').value);
    fd.append('content', tkQuill.root.innerHTML);
    fd.append('cron', document.getElementById('tk_cron').value);
    await fetch('/api/task/add', {method:'POST', body:fd});
    location.reload();
}

async function delTask(tid) {
    if(!confirm("停止并删除此任务？")) return;
    const fd = new FormData(); fd.append('tid', tid);
    await fetch('/api/task/del', {method:'POST', body:fd});
    document.getElementById(`task-${tid}`).remove();
}
</script>
{% endblock %}
