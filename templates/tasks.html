{% extends "layout.html" %}
{% block content %}
<link href="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.snow.css" rel="stylesheet">

<div class="card p-4 border-0 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold m-0"><i class="bi bi- megaphone me-2 text-primary"></i>定时任务配置</h5>
        <button class="btn btn-primary rounded-pill px-4" onclick="handleOpenModal()">+ 新增定时任务</button>
    </div>

    <div class="row g-3">
        {% for t in tasks %}
        <div class="col-md-6" id="t-card-{{t[0]}}">
            <div class="card bg-light p-3 border-0">
                <div class="d-flex justify-content-between">
                    <span class="badge bg-white text-primary mb-2">每 {{t[3]}} 分钟</span>
                    <i class="bi bi-trash text-danger" style="cursor:pointer" onclick="delTask('{{t[0]}}')"></i>
                </div>
                <h6 class="fw-bold">{{t[4]}}</h6>
                <div class="small text-muted text-truncate">{{t[2]|safe}}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body p-4">
                <h6 class="fw-bold mb-4">配置富消息</h6>
                <div class="mb-3">
                    <label class="small fw-bold">任务名称</label>
                    <input type="text" id="t_name" class="form-control border-0 bg-light">
                </div>
                <div class="mb-3">
                    <label class="small fw-bold mb-2">内容编辑 (B/I/U/链接)</label>
                    <div id="editor-wrapper" style="height: 200px; background: white;"></div>
                </div>
                <div class="mb-4">
                    <label class="small fw-bold">周期 (分钟)</label>
                    <input type="number" id="t_time" class="form-control border-0 bg-light" value="60">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light flex-grow-1 rounded-pill" data-bs-dismiss="modal">取消</button>
                    <button class="btn btn-primary flex-grow-1 rounded-pill shadow" onclick="submitTask()">保存并发布</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/quill/1.3.6/quill.min.js"></script>
<script>
let quillInstance = null;
const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));

function handleOpenModal() {
    taskModal.show();
    // 关键：延迟初始化，确保容器已经显示
    setTimeout(() => {
        if (!quillInstance) {
            quillInstance = new Quill('#editor-wrapper', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        ['link', 'blockquote', 'code-block'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                    ]
                },
                placeholder: '在此输入消息内容...'
            });
        }
    }, 500);
}

async function submitTask() {
    const name = document.getElementById('t_name').value;
    const content = quillInstance.root.innerHTML;
    const cron = document.getElementById('t_time').value;

    if(!name || !content) return alert("请填写完整信息");

    const fd = new FormData();
    fd.append('sid', '{{sid}}'); fd.append('gid', '{{gid}}');
    fd.append('remark', name); fd.append('content', content); fd.append('cron', cron);

    try {
        const res = await fetch('/api/add_task', { method: 'POST', body: fd });
        const data = await res.json();
        if(data.status === 'ok') {
            location.reload();
        } else {
            alert("提交失败: " + data.status);
        }
    } catch (e) {
        alert("网络请求失败，请检查后台运行状态");
    }
}

async function delTask(tid) {
    if(!confirm("确定删除？")) return;
    const fd = new FormData(); fd.append('sid','{{sid}}'); fd.append('tid',tid);
    await fetch('/api/del_task', { method: 'POST', body: fd });
    location.reload();
}
</script>
{% endblock %}
